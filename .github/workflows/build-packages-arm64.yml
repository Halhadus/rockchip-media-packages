name: Build Rockchip Packages (ARM64)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 4 * * 0'
  push:
    paths:
      - 'scripts/**'
      - 'Dockerfile'
      - '.github/workflows/**'

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-media:
    name: Build Media Packages
    runs-on: ubuntu-24.04-arm
    container:
      image: debian:trixie
      options: --privileged --platform linux/arm64
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Configure APT Sources
        run: |
          sed -i 's/^Types: deb$/Types: deb deb-src/' /etc/apt/sources.list.d/*.sources
          apt-get update -qq

      - name: Install Media Build Dependencies
        run: |
          DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
            git build-essential devscripts debhelper equivs \
            ca-certificates rsync meson pkg-config wget \
            xorg-dev libx11-xcb-dev libxkbcommon-dev libffi-dev \
            libssl-dev libwayland-dev wayland-protocols \
            libdrm-dev libgbm-dev libgl-dev libegl-dev \
            libstdc++6 libxcb-dri2-0-dev libxcb-dri3-dev \
            libxcb-present-dev libxcb-glx0-dev libxcb-randr0-dev \
            cmake libxcb-shm0-dev libxcb-sync-dev libvulkan-dev libwayland-bin libwayland-client0

      - name: Execute Media Build Script
        run: |
          chmod +x scripts/build.sh
          ./scripts/build.sh
        shell: bash

      - name: Upload Media Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rockchip-media-deb
          path: output/*.deb
          if-no-files-found: error
          retention-days: 7

  build-firefox:
    name: Build Firefox MPP
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 360
    steps:
      - name: Maximize Build Space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 2048
          swap-size-mb: 2048
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'
          remove-docker-images: 'true'

      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Create Work Directories
        run: |
          mkdir -p output
          mkdir -p build_workspace

      - name: Move Docker Data to Workspace
        run: |
          sudo systemctl stop docker
          sudo mkdir -p ${{ github.workspace }}/docker-data
          echo '{"data-root": "${{ github.workspace }}/docker-data"}' | sudo tee /etc/docker/daemon.json
          sudo systemctl start docker
          docker info | grep "Docker Root Dir"

      - name: Run Build inside Docker
        run: |
          docker run --rm --privileged \
            -v ${{ github.workspace }}/output:/root/output \
            -v ${{ github.workspace }}/scripts:/root/scripts \
            -v ${{ github.workspace }}/build_workspace:/root/build_workspace \
            -w /root \
            debian:trixie /bin/bash -c "
              echo ':: Installing Dependencies...' && \
              sed -i 's/^Types: deb\$/Types: deb deb-src/' /etc/apt/sources.list.d/*.sources && \
              apt-get update -qq && \
              apt-get install -y --no-install-recommends \
                build-essential debhelper devscripts equivs git wget curl ca-certificates \
                pkg-config clang llvm lld python3 python3-dev sudo && \
              chmod +x /root/scripts/build_firefox_native.sh && \
              /root/scripts/build_firefox_native.sh
            "

      - name: Upload Firefox Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: firefox-mpp-deb
          path: output/*.deb
          if-no-files-found: error
          retention-days: 7

  publish-repo:
    name: Publish APT Repository
    needs: [build-media, build-firefox]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Download Media Artifacts
        uses: actions/download-artifact@v4
        with:
          name: rockchip-media-deb
          path: repo-build

      - name: Setup Repository Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg-dev apt-utils

      - name: Generate Repository Structure
        run: |
          mkdir -p public/dists/trixie/main/binary-arm64
          mkdir -p public/pool/main
          cp repo-build/*.deb public/pool/main/
          cd public
          dpkg-scanpackages --arch arm64 --multiversion pool/main > dists/trixie/main/binary-arm64/Packages
          gzip -k -f dists/trixie/main/binary-arm64/Packages
          cd dists/trixie
          cat << EOF > Release
          Origin: RockchipPackagesBuilder
          Label: Rockchip Media Packages Unofficial Repo
          Suite: trixie
          Codename: trixie
          Version: 1.0
          Architectures: arm64
          Components: main
          Description: Compiled Rockchip multimedia packages (incl. Firefox MPP)
          Date: $(date -R)
          EOF
          apt-ftparchive release . >> Release

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          force_orphan: true
